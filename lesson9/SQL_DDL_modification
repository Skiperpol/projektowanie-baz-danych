BEGIN;

ALTER TABLE "Variant"
    ADD COLUMN IF NOT EXISTS unique_individual BOOLEAN NOT NULL DEFAULT FALSE;

CREATE TABLE IF NOT EXISTS "SerialStockItem" (
    "id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "shipment_id" INTEGER,
    "warehouse_id" INTEGER NOT NULL,
    "variant_id" INTEGER NOT NULL,
    "serial_number" VARCHAR(40),
    FOREIGN KEY (warehouse_id) REFERENCES "Warehouse"(id),
    FOREIGN KEY (variant_id) REFERENCES "Variant"(id),
    FOREIGN KEY (shipment_id) REFERENCES "Shipment"(id) ON DELETE SET NULL
);

CREATE TABLE IF NOT EXISTS "BulkStockItem" (
    "id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "variant_id" INTEGER NOT NULL,
    "warehouse_id" INTEGER NOT NULL,
    "shipment_id" INTEGER,
    "quantity" INTEGER NOT NULL DEFAULT 1,
    FOREIGN KEY (variant_id) REFERENCES "Variant"(id),
    FOREIGN KEY (warehouse_id) REFERENCES "Warehouse"(id),
    FOREIGN KEY (shipment_id) REFERENCES "Shipment"(id) ON DELETE SET NULL
);

WITH variants AS (
    SELECT 
        id AS variant_id,
        ROW_NUMBER() OVER (ORDER BY id) AS rn,
        COUNT(*) OVER () AS total_count
    FROM "Variant"
),
split AS (
    SELECT
        variant_id,
        rn,
        total_count,
        FLOOR(total_count / 2) AS serial_cutoff
    FROM variants
)
INSERT INTO "SerialStockItem" (shipment_id, warehouse_id, variant_id, serial_number)
SELECT
    SI.shipment_id,
    SI.warehouse_id,
    SI.variant_id,
    CONCAT('SER-', SI.id)
FROM "StockItem" SI
JOIN split S ON S.variant_id = SI.variant_id
WHERE S.rn <= S.serial_cutoff;

WITH variants AS (
    SELECT 
        id AS variant_id,
        ROW_NUMBER() OVER (ORDER BY id) AS rn,
        COUNT(*) OVER () AS total_count
    FROM "Variant"
),
split AS (
    SELECT
        variant_id,
        rn,
        total_count,
        FLOOR(total_count / 2) AS serial_cutoff
    FROM variants
)
INSERT INTO "BulkStockItem" (variant_id, warehouse_id, shipment_id, quantity)
SELECT
    SI.variant_id,
    SI.warehouse_id,
    SI.shipment_id,
    2 AS quantity
FROM "StockItem" SI
JOIN split S ON S.variant_id = SI.variant_id
WHERE S.rn > S.serial_cutoff;

UPDATE "Variant" v
SET unique_individual = TRUE
WHERE EXISTS (
    SELECT 1
    FROM "SerialStockItem" s
    WHERE s.variant_id = v.id
);

UPDATE "Variant" v
SET unique_individual = FALSE
WHERE EXISTS (
    SELECT 1
    FROM "BulkStockItem" b
    WHERE b.variant_id = v.id
);

ALTER TABLE "OrderItem" DROP CONSTRAINT IF EXISTS fk_orderitem_stockitem;
DROP TABLE IF EXISTS "StockItem";


CREATE TABLE IF NOT EXISTS "OrderStockAllocation" (
    "id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
    "order_item_id" INTEGER NOT NULL,
    "bulk_stock_item_id" INTEGER,
    "serial_stock_item_id" INTEGER,
    "allocated_quantity" INTEGER NOT NULL,
    "allocated_at" TIMESTAMPTZ NOT NULL,
    PRIMARY KEY("id")
);

ALTER TABLE "OrderStockAllocation"
    ADD CONSTRAINT fk_orderstockallocation_orderitem
        FOREIGN KEY (order_item_id) REFERENCES "OrderItem"(id) ON DELETE CASCADE,
    ADD CONSTRAINT fk_orderstockallocation_bulk
        FOREIGN KEY (bulk_stock_item_id) REFERENCES "BulkStockItem"(id) ON DELETE SET NULL,
    ADD CONSTRAINT fk_orderstockallocation_serial
        FOREIGN KEY (serial_stock_item_id) REFERENCES "SerialStockItem"(id) ON DELETE SET NULL;

ALTER TABLE "OrderItem" DROP COLUMN IF EXISTS stock_item_id;
 
ALTER TABLE "OrderItem"
    ADD COLUMN IF NOT EXISTS variant_id INTEGER NOT NULL DEFAULT 1,
    ADD COLUMN IF NOT EXISTS quantity INTEGER NOT NULL DEFAULT 1,
    ADD CONSTRAINT fk_orderitem_variant FOREIGN KEY (variant_id) REFERENCES "Variant"(id);


INSERT INTO "OrderStockAllocation" (order_item_id, serial_stock_item_id, allocated_quantity, allocated_at)
SELECT 
    OI.id AS order_item_id,
    SS.id AS serial_stock_item_id,
    1 AS allocated_quantity,
    NOW() AS allocated_at
FROM "OrderItem" OI
JOIN "Variant" V ON V.id = OI.variant_id AND V.unique_individual = TRUE
JOIN LATERAL (
    SELECT id 
    FROM "SerialStockItem" SSI
    WHERE SSI.variant_id = V.id
    ORDER BY RANDOM()
    LIMIT OI.quantity
) SS ON TRUE;

INSERT INTO "OrderStockAllocation" (order_item_id, bulk_stock_item_id, allocated_quantity, allocated_at)
SELECT 
    OI.id AS order_item_id,
    BSI.id AS bulk_stock_item_id,
    LEAST(OI.quantity, BSI.quantity) AS allocated_quantity,
    NOW() AS allocated_at
FROM "OrderItem" OI
JOIN "Variant" V ON V.id = OI.variant_id AND V.unique_individual = FALSE
JOIN "BulkStockItem" BSI ON BSI.variant_id = V.id;

COMMIT;
