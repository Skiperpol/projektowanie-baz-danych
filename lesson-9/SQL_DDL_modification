BEGIN;

ALTER TABLE "Variant"
    ADD COLUMN IF NOT EXISTS unique_individual BOOLEAN NOT NULL DEFAULT TRUE;

CREATE TABLE IF NOT EXISTS "SerialStockItem" (
    "id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "shipment_id" INTEGER,
    "warehouse_id" INTEGER NOT NULL,
    "variant_id" INTEGER NOT NULL,
    "serial_number" VARCHAR(40),
    FOREIGN KEY (warehouse_id) REFERENCES "Warehouse"(id),
    FOREIGN KEY (variant_id) REFERENCES "Variant"(id),
    FOREIGN KEY (shipment_id) REFERENCES "Shipment"(id) ON DELETE SET NULL
);

CREATE TABLE IF NOT EXISTS "BulkStockItem" (
    "id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "variant_id" INTEGER NOT NULL,
    "warehouse_id" INTEGER NOT NULL,
    "shipment_id" INTEGER,
    "quantity" INTEGER NOT NULL DEFAULT 1,
    FOREIGN KEY (variant_id) REFERENCES "Variant"(id),
    FOREIGN KEY (warehouse_id) REFERENCES "Warehouse"(id),
    FOREIGN KEY (shipment_id) REFERENCES "Shipment"(id) ON DELETE SET NULL
);

INSERT INTO "SerialStockItem" (shipment_id, warehouse_id, variant_id, serial_number)
SELECT
    shipment_id,
    warehouse_id,
    variant_id,
    CONCAT('SER-', id)
FROM "StockItem";

CREATE TABLE IF NOT EXISTS "OrderStockAllocation" (
    "id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "order_item_id" INTEGER NOT NULL,
    "bulk_stock_item_id" INTEGER,
    "serial_stock_item_id" INTEGER,
    "allocated_quantity" INTEGER NOT NULL,
    "allocated_at" TIMESTAMPTZ NOT NULL
);

ALTER TABLE "OrderStockAllocation"
    ADD CONSTRAINT fk_orderstockallocation_orderitem
        FOREIGN KEY (order_item_id) REFERENCES "OrderItem"(id) ON DELETE CASCADE,
    ADD CONSTRAINT fk_orderstockallocation_bulk
        FOREIGN KEY (bulk_stock_item_id) REFERENCES "BulkStockItem"(id) ON DELETE SET NULL,
    ADD CONSTRAINT fk_orderstockallocation_serial
        FOREIGN KEY (serial_stock_item_id) REFERENCES "SerialStockItem"(id) ON DELETE SET NULL;

ALTER TABLE "OrderItem"
    ADD COLUMN IF NOT EXISTS variant_id INTEGER,
    ADD COLUMN IF NOT EXISTS quantity INTEGER;

UPDATE "OrderItem" oi
SET
    variant_id = si.variant_id,
    quantity = 1
FROM "StockItem" si
WHERE oi.stock_item_id = si.id;

INSERT INTO "OrderStockAllocation" (order_item_id, serial_stock_item_id, allocated_quantity, allocated_at)
SELECT
    oi.id,
    ss.id,
    oi.quantity,
    NOW()
FROM "OrderItem" oi
JOIN "StockItem" si ON oi.stock_item_id = si.id
JOIN "SerialStockItem" ss ON ss.serial_number = CONCAT('SER-', si.id);

ALTER TABLE "OrderItem"
DROP COLUMN IF EXISTS stock_item_id;

DROP TABLE IF EXISTS "StockItem" CASCADE;

CREATE UNIQUE INDEX IF NOT EXISTS uq_serialstockitem_variant_serial
ON "SerialStockItem"(variant_id, serial_number);

COMMIT;


